---
import "../../styles/global.css";
import AutoCard from "../../components/AutoCard.astro";
import { supabase } from "../../lib/supabase";

const { data: autoshow, error } = await supabase
  .from("AutoShow")
  .select("type, image, accent")
  .order("created_at", { ascending: true });

if (error) {
  throw new Error(error.message);
}

const event = autoshow.filter(item => item.type === "autoshow");
// Double for desktop loop; mobile will handle this via script
const loopEvents = [...event, ...event];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
r   <title>Tech Events | 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Inter:wght@300;400&display=swap" rel="stylesheet" />
    
    <style>
      :root {
        --bg-color: #040503;
        --accent-cyan: #00f2ff;
      }

      body {
        font-family: 'Inter', sans-serif;
        background-color: #040503;
        background-image: url("/asfalt-light.png");
        color: white;
        overflow-x: hidden;
      }

      .font-orbitron { font-family: 'Orbitron', sans-serif; }

      /* Container Logic */
      .slider-container {
        width: 100%;
        position: relative;
        padding: 2rem 0;
        /* Cinematic fade for desktop */
        mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
        -webkit-mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
      }

      /* Mobile Smooth Flow: Scroll Snapping */
      @media (max-width: 768px) {
        .slider-container {
          mask-image: none;
          -webkit-mask-image: none;
          overflow-x: scroll;
          scroll-snap-type: x mandatory;
          scroll-behavior: smooth;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none;
          padding: 1rem 0;
        }
        .slider-container::-webkit-scrollbar { display: none; }
        
        #track {
          padding-left: 1.5rem; /* Allow first card to align with padding */
          padding-right: 1.5rem;
        }
      }

      .card-wrapper {
        flex-shrink: 0;
        width: 80vw; /* Shows a bit of the next card */
        scroll-snap-align: center;
        transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
      }

      @media (min-width: 768px) {
        .card-wrapper { width: 400px; }
      }

      /* Progress Bar Stylings */
      .scroll-progress-bg {
        width: 100px;
        height: 2px;
        background: rgba(255,255,255,0.1);
        position: relative;
        overflow: hidden;
      }
      #scroll-progress-fill {
        position: absolute;
        top: 0; left: 0;
        height: 100%;
        width: 0%;
        background: var(--accent-cyan);
        box-shadow: 0 0 10px var(--accent-cyan);
      }
    </style>
  </head>
  
  <body class="min-h-screen flex flex-col justify-center">
    
    <div class="container mx-auto px-6 md:px-10 mb-6 z-20">
      <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
          <h2 class="text-[10px] tracking-[0.4em] text-cyan-400 font-bold uppercase mb-1">2026 AUTOSHOW</h2>
          <h1 class="text-4xl sm:text-6xl md:text-7xl font-black uppercase font-orbitron tracking-tighter italic">
            CAMARO <span class="opacity-30">EVENTS</span>
          </h1>
        </div>
        <p class="text-gray-400 max-w-xs text-xs md:text-sm leading-relaxed border-l-2 border-cyan-500/50 pl-4 py-1">
          Automobile and Mechanical presents the automobile expo
        </p>
      </div>
    </div>

    <div class="slider-container">
      <div id="track" class="flex gap-6 md:gap-10">
        {loopEvents.map((event) => (
          <div class="card-wrapper">
            <AutoCard 
              title={event.title} 
              image={event.image} 
              accent={event.accent} 
            />
          </div>
        ))}
      </div>
    </div>

    <div class="flex flex-col items-center gap-6 mt-4">
        <div class="flex items-center gap-4">
          <span class="text-[10px] font-mono text-gray-500">01</span>
          <div class="scroll-progress-bg">
            <div id="scroll-progress-fill"></div>
          </div>
          <span class="text-[10px] font-mono text-gray-500">05</span>
        </div>

        <div class="hidden md:flex justify-center items-center gap-12">
            <button id="prevBtn" class="group flex items-center gap-3 text-xs tracking-widest uppercase font-bold text-gray-500 hover:text-cyan-400 transition-all">
              <span class="h-[1px] w-8 bg-gray-700 group-hover:bg-cyan-400 transition-all"></span> PREV
            </button>
            <button id="nextBtn" class="group flex items-center gap-3 text-xs tracking-widest uppercase font-bold text-gray-500 hover:text-cyan-400 transition-all">
              NEXT <span class="h-[1px] w-8 bg-gray-700 group-hover:bg-cyan-400 transition-all"></span>
            </button>
        </div>
    </div>

<script>
  import { gsap } from "gsap";

  document.addEventListener('DOMContentLoaded', () => {
    const track = document.querySelector('#track') as HTMLElement;
    const container = document.querySelector('.slider-container') as HTMLElement;
    const progressFill = document.querySelector('#scroll-progress-fill') as HTMLElement;
    
    if (!track || !container) return;

    const isTouchDevice = window.matchMedia("(pointer: coarse)").matches;
    const loopWidth = track.scrollWidth / 2;

    if (!isTouchDevice) {
      // DESKTOP: GSAP Auto-Scroll Logic
      const animation = gsap.to(track, {
        x: `-=${loopWidth}`,
        duration: 25,
        ease: "none",
        repeat: -1,
        onUpdate: () => {
           // Simple math to fill progress bar based on 0 to loopWidth
           const currentX = Math.abs(gsap.getProperty(track, "x") as number % loopWidth);
           const progress = (currentX / loopWidth) * 100;
           if (progressFill) progressFill.style.width = `${progress}%`;
        },
        modifiers: {
          x: gsap.utils.unitize(x => parseFloat(x) % loopWidth)
        }
      });

      track.addEventListener('mouseenter', () => gsap.to(animation, {timeScale: 0, duration: 0.5}));
      track.addEventListener('mouseleave', () => gsap.to(animation, {timeScale: 1, duration: 0.5}));

      document.getElementById('nextBtn')?.addEventListener('click', () => {
        gsap.to(track, { x: "-=440", duration: 0.6, ease: "power2.out" });
      });
      document.getElementById('prevBtn')?.addEventListener('click', () => {
        gsap.to(track, { x: "+=440", duration: 0.6, ease: "power2.out" });
      });

    } else {
      // MOBILE: Native Scroll Logic
      // Remove duplicates for mobile to keep the scrollbar accurate
      const cards = document.querySelectorAll('.card-wrapper');
      cards.forEach((card, index) => {
        if (index >= cards.length / 2) (card as HTMLElement).remove();
      });

      // Update progress bar on scroll
      container.addEventListener('scroll', () => {
        const maxScroll = container.scrollWidth - container.clientWidth;
        const currentScroll = container.scrollLeft;
        const progress = (currentScroll / maxScroll) * 100;
        if (progressFill) progressFill.style.width = `${progress}%`;
      });
    }
  });
</script>

  </body>
</html>
