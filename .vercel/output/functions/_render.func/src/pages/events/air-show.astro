---
import "../../styles/global.css";
import TechCard from "../../components/TechCard.astro";
import AutoCard from "../../components/AutoCard.astro";
import RegisterModal from "../../components/RegisterModal.astro";
import { supabase } from "../../lib/supabase";

const { data: programs, error1 } = await supabase.from("programs").select(`
    slug,
    type,
    program_details (
      title,
      short_description,
      accent,
      image
    ),
    program_tags (
      tags (
        name
      )
    )
  `);

  const { data: AutoShow, error } = await supabase.from("AutoShow").select(`
    type,
  image,
  accent
  `);

if (error) throw error;
if (error1) throw error;


const events = programs.filter((p) => p.type === "airshow");
const competitions = programs.filter((p) => p.type === "workshop");
const AirShow = AutoShow.filter((p) => p.type === "Air Show");



// Keep the loop for desktop, we'll handle mobile visibility via CSS
const loopEvents = [...AirShow, ...AirShow];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tech Events & Competitions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet" />

    <style>
      :root {
        --accent-cyan: #22d3ee; /* Fixed missing variable */
      }
      body {
        font-family: "Orbitron", sans-serif;
        background-color: #040503;
        background-image: url("/asfalt-light.png");
        overflow-x: hidden;
      }

      .slider-container {
        width: 100%;
        overflow: hidden; /* Prevent horizontal scrollbars on desktop */
        position: relative;
        padding: 2rem 0;
        mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
        -webkit-mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
      }

      @media (max-width: 768px) {
        .slider-container {
          mask-image: none;
          -webkit-mask-image: none;
          overflow-x: auto;
          scroll-snap-type: x mandatory;
          padding: 1rem 0;
        }
        /* Hide the second half of cards on mobile to prevent infinite loop confusion */
        .card-wrapper:nth-child(n+6) {
          display: none;
        }
      }

      .card-wrapper {
        flex-shrink: 0;
        width: 75vw;
        scroll-snap-align: center;
      }

      @media (min-width: 768px) {
        .card-wrapper {
          width: 400px;
        }
      }

      .scroll-progress-bg {
        width: 150px;
        height: 2px;
        background: rgba(255, 255, 255, 0.1);
        position: relative;
      }
      
      #scroll-progress-fill {
        position: absolute;
        height: 100%;
        width: 0%;
        background: var(--accent-cyan);
        box-shadow: 0 0 10px var(--accent-cyan);
        transition: width 0.1s ease-out;
      }
    </style>
  </head>

  <body>
    <div class="min-h-screen px-6 py-12 md:p-16 lg:p-24 max-w-7xl mx-auto">
           <!-- EVENTS -->
      <section class="mb-20 md:mb-24">
        <h1 class="section-heading text-white text-3xl md:text-5xl font-black uppercase tracking-[0.15em] md:tracking-[0.2em] mb-4">
          Events
        </h1>

        <div class="w-16 md:w-24 h-[3px] bg-cyan-400 mb-8 md:mb-12"></div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-10">
          {
            events.map(event => (
              <TechCard
                slug={event.slug}
                title={event.program_details.title}
                description={event.program_details.short_description}
                link={`/events/${event.slug}`}
                tag={event.program_tags[0]?.tags?.name ?? ""}
                image={event.program_details.image}
                accent={event.program_details.accent}
              />
            ))
          }
        </div>
      </section>


      <!-- COMPETITIONS -->
      <section>
        <h1
          class="section-heading text-white text-3xl md:text-5xl font-black uppercase tracking-[0.15em] md:tracking-[0.2em] mb-4"
        >
          Tech Events
        </h1>

        <div class="w-16 md:w-24 h-[3px] bg-pink-500 mb-8 md:mb-12"></div>

        <div
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-10"
        >
          {
            competitions.map((comp) => (
              <TechCard
                slug={comp.slug}
                title={comp.program_details.title}
                description={comp.program_details.short_description}
                link={`/events/${comp.slug}`}
                tag={comp.program_tags[0]?.tags?.name ?? ""}
                image={comp.program_details.image}
                accent={comp.program_details.accent}
              />
            ))
          }
        </div>
      </section>


      <section class="mt-32">
        <h1 class="section-heading text-white text-3xl md:text-5xl font-black uppercase tracking-widest mb-4">ISRO : SPACE ON WHEELS </h1>
        <div class="w-20 h-[3px] bg-pink-500 mb-12"></div>

        <div class="slider-container" id="sliderContainer">
          <div id="track" class="flex gap-6 md:gap-10 w-max">
            {loopEvents.map((card) => (
              <div class="card-wrapper">
                <AutoCard title={card.title} image={card.image} accent={card.accent} />
              </div>
            ))}
          </div>
        </div>

        <div class="flex flex-col items-center gap-8 mt-12">
          <div class="flex items-center gap-4">
            <span class="text-[10px] font-mono text-gray-500">START</span>
            <div class="scroll-progress-bg">
              <div id="scroll-progress-fill"></div>
            </div>
            <span class="text-[10px] font-mono text-gray-500">END</span>
          </div>

          <div class="hidden md:flex gap-12">
            <button id="prevBtn" class="group flex items-center gap-3 text-xs font-bold text-gray-500 hover:text-cyan-400 transition-all">
              <span class="h-[1px] w-8 bg-gray-700 group-hover:bg-cyan-400"></span> PREV
            </button>
            <button id="nextBtn" class="group flex items-center gap-3 text-xs font-bold text-gray-500 hover:text-cyan-400 transition-all">
              NEXT <span class="h-[1px] w-8 bg-gray-700 group-hover:bg-cyan-400"></span>
            </button>
          </div>
        </div>
      </section>
    </div>

    <RegisterModal />

    <script>
      import { gsap } from "gsap";

      document.addEventListener("DOMContentLoaded", () => {
        const track = document.querySelector("#track");
        const container = document.querySelector("#sliderContainer");
        const progressFill = document.querySelector("#scroll-progress-fill");
        
        if (!track || !container || !progressFill) return;

        const isMobile = window.innerWidth < 768;

        if (!isMobile) {
          // DESKTOP: Infinite Loop
          const loopWidth = track.scrollWidth / 2;
          
          const animation = gsap.to(track, {
            x: -loopWidth,
            duration: 30,
            ease: "none",
            repeat: -1,
            modifiers: {
              x: gsap.utils.unitize(x => parseFloat(x) % loopWidth)
            },
            onUpdate: function() {
              const progress = (Math.abs(gsap.getProperty(track, "x")) / loopWidth) * 100;
              progressFill.style.width = `${progress}%`;
            }
          });

          // Pause on hover
          track.addEventListener("mouseenter", () => gsap.to(animation, { timeScale: 0, duration: 0.5 }));
          track.addEventListener("mouseleave", () => gsap.to(animation, { timeScale: 1, duration: 0.5 }));

          // Manual buttons
          document.getElementById("nextBtn")?.addEventListener("click", () => {
            gsap.to(track, { x: "-=440", duration: 0.5, ease: "power2.out" });
          });
          document.getElementById("prevBtn")?.addEventListener("click", () => {
            gsap.to(track, { x: "+=440", duration: 0.5, ease: "power2.out" });
          });
        } else {
          // MOBILE: Native Scroll Progress
          container.addEventListener("scroll", () => {
            const max = container.scrollWidth - container.clientWidth;
            const percentage = (container.scrollLeft / max) * 100;
            progressFill.style.width = `${percentage}%`;
          });
        }
      });
    </script>
  </body>
</html>
