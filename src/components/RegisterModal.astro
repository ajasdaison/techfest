<div
  id="register-modal"
  class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/90 backdrop-blur-md"
>
  <div class="w-full max-w-lg bg-[#020008] border border-cyan-400/30 rounded-xl p-8 relative shadow-[0_0_50px_rgba(6,182,212,0.3)]">
    <button
      id="close-register"
      type="button"
      class="absolute top-4 right-4 text-cyan-400 hover:text-white transition-colors text-2xl p-2"
    >
      ✕
    </button>

    <h2
      id="modal-title"
      class="text-2xl uppercase tracking-[0.2em] text-cyan-300 mb-8 font-bold border-b border-cyan-900 pb-4"
    >
      Register
    </h2>

    <form id="register-form" class="space-y-6">
      <input type="hidden" name="programSlug" id="programSlug" />

      <input
        name="name"
        required
        placeholder="Full Name"
        class="w-full bg-black/60 border border-cyan-400/30 px-4 py-3 rounded-md text-cyan-100 focus:outline-none focus:border-cyan-400"
      />

      <input
        name="email"
        type="email"
        required
        placeholder="Email"
        class="w-full bg-black/60 border border-cyan-400/30 px-4 py-3 rounded-md text-cyan-100 focus:outline-none focus:border-cyan-400"
      />

      <input
        name="phone"
        required
        placeholder="Phone"
        class="w-full bg-black/60 border border-cyan-400/30 px-4 py-3 rounded-md text-cyan-100 focus:outline-none focus:border-cyan-400"
      />

      <button
        id="submit-btn"
        type="submit"
        class="w-full bg-cyan-500/20 hover:bg-cyan-500/40 border border-cyan-400/40 py-4 rounded-md uppercase tracking-[0.3em] text-cyan-300 font-bold transition-all disabled:opacity-50"
      >
        Confirm Registration
      </button>
    </form>
  </div>
</div>

<script>
  import { actions } from "astro:actions";

  console.log("Modal Script Loaded");

  const init = () => {
    const modal = document.getElementById("register-modal");
    const form = document.getElementById("register-form") as HTMLFormElement;
    const slugInput = document.getElementById("programSlug") as HTMLInputElement;
    const titleEl = document.getElementById("modal-title");
    const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;

    if (!modal || !form) return;

    // 1. GLOBAL CLICK HANDLER (Event Delegation)
    // This works even if cards are loaded late
    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      const btn = target.closest("[data-register]") as HTMLElement;
      
      if (btn) {
        console.log("Register Button Clicked:", btn.dataset.slug);
        e.preventDefault();
        
        slugInput.value = btn.dataset.slug || "";
        if (titleEl) titleEl.textContent = `Register — ${btn.dataset.title}`;
        
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.body.style.overflow = "hidden";
      }
    });

    // 2. CLOSE MODAL LOGIC
    const closeModal = () => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      document.body.style.overflow = "auto";
    };

    document.getElementById("close-register")?.addEventListener("click", closeModal);
    
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    // 3. FORM SUBMISSION
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      submitBtn.disabled = true;
      submitBtn.innerText = "SENDING...";

      const formData = new FormData(form);

      try {
        const { data, error } = await actions.registerParticipant({
          programSlug: formData.get("programSlug")?.toString() || "",
          participantName: formData.get("name")?.toString() || "",
          email: formData.get("email")?.toString() || "",
          phone: formData.get("phone")?.toString() || "",
        });

        if (error) {
          alert("Error: " + error.message);
        } else {
          alert("Registration Successful!");
          form.reset();
          closeModal();
        }
      } catch (err) {
        console.error("Submission error:", err);
        alert("A system error occurred.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = "CONFIRM REGISTRATION";
      }
    });
  };

  // Run on load
  init();
  // Run on view transitions
  document.addEventListener("astro:after-swap", init);
</script>
