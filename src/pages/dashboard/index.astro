---
import { createBEClient } from "../../lib/supabase-admin";

const supabase = createBEClient({
  request: Astro.request,
  cookies: Astro.cookies,
});

const { data: auth } = await supabase.auth.getUser();
if (!auth.user) {
  return Astro.redirect("/");
}

const { data: profile, error } = await supabase
  .from("profiles")
  .select("role")
  .eq("id", auth.user.id)
  .single();

if (error || !profile) {
  throw new Error("Profile not found");
}

if (profile.role === "admin") {
  return Astro.redirect("/dashboard/admin");
}

return Astro.redirect("/dashboard/coordinator");
---

